<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AviMetric PP - Inoiatech</title>

  <style>
    :root{
      --primary-color:#2c5e1a; --secondary-color:#4a8c2a; --accent-color:#ff9800;
      --card-bg:#ffffff; --text-color:#333; --text-light:#666;
      --success:#28a745; --danger:#dc3545; --warning:#ffc107; --info:#17a2b8;
      --radius:10px; --shadow:0 4px 6px rgba(0,0,0,.1); --transition:all .3s ease;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;background:#f0f2f5;color:var(--text-color);line-height:1.6;padding:20px; padding-bottom: 80px;}
    body[dir="rtl"]{direction:rtl}
    .container{max-width:1600px;margin:0 auto}
    
    /* MODIFICATION HEADER */
    .header{
        background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
        color:#fff;padding:25px;border-radius:var(--radius);
        box-shadow:var(--shadow);text-align:center;
        display: flex; flex-direction: column; align-items: center;
    }
    .logo-img {
        max-height: 80px; margin-bottom: 10px;
        background: white; padding: 5px; border-radius: 8px;
    }
    .header h1{font-size:32px;margin:5px 0;font-weight:700}
    .subtitle{font-size:18px;opacity:.95; margin-bottom: 15px;}

    .company-brand{display:inline-block;margin-top:15px;padding:8px 20px;background:rgba(255,255,255,.15);border-radius:50px;font-size:16px;font-weight:600;letter-spacing:.4px}
    .action-buttons{display:flex;justify-content:center;gap:12px;margin-top:22px;flex-wrap:wrap}
    .action-btn{padding:12px 22px;border:none;border-radius:50px;font-size:16px;font-weight:700;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:8px;box-shadow:0 3px 5px rgba(0,0,0,.2)}
    .btn-reset{background:#fff;color:var(--primary-color)}
    .btn-save{background:var(--accent-color);color:#fff}
    .btn-pdf{background:var(--danger);color:#fff}
    .btn-compare{background:var(--info);color:#fff}
    .action-btn:hover{transform:translateY(-3px)}
    
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:25px 0}
    .dashboard-card{background:var(--card-bg);border-radius:var(--radius);padding:25px;box-shadow:var(--shadow);text-align:center;border-top:4px solid var(--primary-color);transition:var(--transition)}
    .dashboard-card:hover{transform:translateY(-5px);box-shadow:0 6px 12px rgba(0,0,0,.15)}
    .dashboard-icon{font-size:36px;margin-bottom:12px;color:var(--primary-color)}
    .dashboard-value{font-size:32px;font-weight:800;margin:10px 0;color:var(--primary-color)}
    .dashboard-label{font-size:14px;color:var(--text-light);text-transform:uppercase;letter-spacing:1px;font-weight:700}
    .dashboard-unit{font-size:16px;color:var(--text-light);margin-left:5px}
    
    .tabs{display:flex;border-bottom:2px solid #eee;margin-bottom:20px;flex-wrap:wrap}
    .tab{padding:12px 24px;cursor:pointer;font-weight:800;color:var(--text-light);border-bottom:3px solid transparent;display:flex;align-items:center;gap:8px;margin-bottom:-2px}
    .tab.active{color:var(--primary-color);border-bottom-color:var(--primary-color)}
    .tab:hover:not(.active){color:var(--secondary-color)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    .content{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
    @media(max-width:1024px){.content{grid-template-columns:1fr}}
    .column{display:flex;flex-direction:column;gap:25px}
    .section{background:var(--card-bg);border-radius:var(--radius);padding:28px;box-shadow:var(--shadow)}
    .section-title{color:var(--primary-color);border-bottom:2px solid #eee;padding-bottom:12px;margin-bottom:20px;font-size:22px;font-weight:800;display:flex;align-items:center;gap:10px}
    
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    @media(max-width:768px){.form-grid{grid-template-columns:1fr}}
    .form-group{margin-bottom:10px}
    .form-label{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:800;font-size:15px}
    body[dir="rtl"] .form-label{text-align:right}
    .input-with-unit{position:relative}
    .form-input{width:100%;padding:14px 15px;border:1px solid #ddd;border-radius:8px;font-size:16px;transition:var(--transition);background:#fafafa}
    .form-input:focus{outline:none;border-color:var(--secondary-color);background:#fff;box-shadow:0 0 0 3px rgba(74,140,42,.1)}
    .unit{position:absolute;right:15px;top:50%;transform:translateY(-50%);color:var(--text-light);font-weight:700}
    body[dir="rtl"] .unit{right:auto;left:15px}
    .additional-info{font-size:13px;color:var(--text-light);margin-top:6px;font-style:italic}
    
    .calculate-btn-container{text-align:center;margin-top:10px}
    .calculate-btn{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;border:none;padding:18px 40px;border-radius:50px;cursor:pointer;font-size:18px;font-weight:800;transition:var(--transition);box-shadow:0 4px 15px rgba(44,94,26,.2);display:inline-flex;align-items:center;gap:10px}
    .calculate-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(44,94,26,.3)}
    
    .results-table{width:100%;border-collapse:collapse;margin-top:12px}
    .results-table th{background:#f8f9fa;padding:12px 15px;text-align:left;font-weight:900;color:var(--primary-color);border-bottom:2px solid #eee}
    body[dir="rtl"] .results-table th{text-align:right}
    .results-table td{padding:12px 15px;border-bottom:1px solid #eee}
    .results-table .value{font-weight:900;text-align:right}
    body[dir="rtl"] .results-table .value{text-align:left}
    
    .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:22px;margin-top:12px;align-items:stretch}
    .chart-container{background:var(--card-bg);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow);position:relative;min-height:380px}
    .chart-title{color:var(--primary-color);margin-bottom:14px;font-size:18px;font-weight:900;text-align:center}
    .chart-canvas{width:100%;height:320px;display:block}
    
    
    @media (max-width:480px){.charts-grid{grid-template-columns:1fr}.chart-container{min-height:320px;padding:16px}.chart-canvas{height:260px}}
.benchmark-table{width:100%;border-collapse:collapse;margin-top:12px}
    .benchmark-table th{background:#f8f9fa;padding:12px 15px;text-align:left;font-weight:900;color:var(--primary-color);border-bottom:2px solid #eee}
    body[dir="rtl"] .benchmark-table th{text-align:right}
    .benchmark-table td{padding:12px 15px;border-bottom:1px solid #eee}
    
    .good{color:var(--success);font-weight:900}
    .warning{color:var(--warning);font-weight:900}
    .bad{color:var(--danger);font-weight:900}
    
    /* SIGNATURE OFFICIELLE */
    .footer-sig{
        text-align:center; margin-top:40px; padding:20px; background:white;
        border-radius:var(--radius); box-shadow:var(--shadow); border-top:4px solid var(--accent-color);
        color: var(--text-color);
    }

    .notification{position:fixed;top:20px;right:20px;padding:14px 22px;border-radius:var(--radius);color:#fff;font-weight:900;box-shadow:var(--shadow);z-index:3000;opacity:0;transform:translateY(-20px);transition:opacity .3s,transform .3s}
    .notification.show{opacity:1;transform:translateY(0)}
    .notification.success{background:var(--success)} .notification.warning{background:var(--warning);color:#333} .notification.error{background:var(--danger)}
    
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:4000;align-items:center;justify-content:center}
    .modal-content{background:#fff;border-radius:var(--radius);padding:26px;width:92%;max-width:560px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .modal-title{font-size:22px;color:var(--primary-color);margin-bottom:14px;text-align:center;font-weight:900}
    .modal-buttons{display:flex;gap:12px;justify-content:center;margin-top:18px;flex-wrap:wrap}
    .modal-btn{padding:12px 22px;border:none;border-radius:8px;font-weight:900;cursor:pointer;transition:var(--transition)}
    .modal-btn.confirm{background:var(--primary-color);color:#fff}
    .modal-btn.cancel{background:#6c757d;color:#fff}
  
    /* RTL: keep numbers readable */
    html[dir="rtl"] input,
    html[dir="rtl"] .dashboard-value,
    html[dir="rtl"] .results-table .value,
    html[dir="rtl"] .benchmark-table td{
      direction:ltr;
    }
    html[dir="rtl"] .results-table .value{ text-align:left; }
    

    /* FX box (visible only when currency != DZD) */
    .fx-box{
      display:none;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      border-radius:50px;
      background:rgba(255,255,255,.15);
      box-shadow:0 3px 5px rgba(0,0,0,.15);
    }
    .fx-box .fx-title{
      font-weight:900;
      color:#fff;
      opacity:.95;
      margin-right:6px;
      white-space:nowrap;
    }
    .fx-box .fx-label, .fx-box .fx-cur{
      font-weight:900;
      color:#fff;
      white-space:nowrap;
    }
    .fx-box input{
      width:110px;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.55);
      background:rgba(255,255,255,.95);
      font-weight:900;
      text-align:right;
    }
    body[dir="rtl"] .fx-box input{ direction:ltr; text-align:right; }


    /* FX box when placed inside forms (advanced parameters) */
    .section .fx-box{
      display:none;
      background:#fafafa;
      border:1px solid #ddd;
      border-radius:8px;
      padding:12px 14px;
      box-shadow:none;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .section .fx-box .fx-title,
    .section .fx-box .fx-label,
    .section .fx-box .fx-cur{
      color:var(--text-color);
      opacity:1;
    }
    .section .fx-box input{
      border:1px solid #ddd;
      background:#fff;
      padding:12px 12px;
      border-radius:8px;
      width:140px;
    }

</style>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ===== I18N AVEC ANGLAIS AJOUTÉ =====
    let INOIA_LANG = "fr";
    const langs = ["fr", "ar", "en"];
    const I18N = { fr: {}, ar: {}, en: {} };

    I18N.fr = {
      title_main: "AviMetric PP",
      subtitle: "Calculateur technicoéconomique pour poule pondeuse",
      brand: "Recherche et développement en nutrition animale",
      btn_reset: "Valeurs par défaut",
      btn_save: "Sauvegarder",
      btn_compare: "Comparer",
      btn_pdf: "Rapport PDF",
      btn_instant: "Calcul instantané",
      tab_params: "Paramètres",
      tab_results: "Résultats",
      tab_analysis: "Analyses",
      tab_benchmarks: "Benchmarks",
      sec_base: "I. Variables de Base",
      sec_prod: "II. Production & Vente",
      sec_costs: "III. Charges Indirectes",
      sec_adv: "Paramètres avancés",
      calc_btn: "Calculer le cycle",
      refresh_charts: "Actualiser graphiques",
      instant_title: "Calcul instantané (jour j / semaine t)",
      instant_help: "Choisissez une semaine ou un jour dans le cycle.",
      instant_week: "Semaine (t)",
      instant_day: "Jour (j)",
      use_observed: "Utiliser valeurs observées",
      obs_laying: "Ponte observée (%)",
      obs_feed: "Conso observée (g/j)",
      run_instant: "Calculer",
      close: "Fermer",
      dash_eggs_cycle: "Œufs totaux (cycle)",
      dash_ca: "Chiffre d'affaires",
      dash_profit: "Bénéfice net",
      dash_feed_total: "Aliment total",
      lbl_housed_hens: "Nombre de poules logées",
      lbl_cum_mortality: "Mortalité cumulée",
      lbl_age_start: "Âge début de ponte",
      lbl_age_end: "Âge fin de cycle",
      lbl_pullet_price: "Prix d'achat poulette",
      lbl_egg_price: "Prix de vente œuf",
      lbl_peak_model: "Ponte pic (modèle)",
      lbl_peak_week: "Semaine du pic",
      lbl_decline: "Déclin après pic",
      lbl_daily_feed: "Conso journalière",
      lbl_feed_price: "Prix aliment",
      lbl_feed_coef: "Coef variation conso",
      lbl_rent: "Location bâtiment",
      lbl_labor: "Main d'œuvre",
      lbl_energy: "Énergie",
      lbl_health_per_hen: "Santé (DA/poule)",
      lbl_other_fees: "Autres frais",
      lbl_water_cost: "Coût de l'eau",
      lbl_insurance: "Assurance",
      lbl_bank_fees: "Frais bancaires",
      lbl_vet_extra: "Frais vétérinaires sup.",
      unit_heads: "têtes",
      unit_weeks: "sem",
      unit_days: "j",
      unit_da: "DA",
      unit_da_per_egg: "DA/u",
      unit_da_per_kg: "DA/kg",
      unit_pct_per_week: "%/sem",
      unit_g_per_day: "g/j",
      unit_coef: "coef",
      unit_pct: "%",
      unit_g: "g",
      unit_kg: "kg",
      hdr_econ_summary: "Synthèse économique",
      hdr_tech_indicators: "Indicateurs techniques",
      hdr_cost_breakdown: "Répartition des coûts",
      hdr_sensitivity: "Analyse de sensibilité",
      hdr_yields: "Rendements",
      tab_results_cycle: "Résultats cycle",
      instant_results: "Résultats instantanés",
      bm_recommended: "Indicateurs recommandés",
      bm_recommendations: "Recommandations",
      bm_reco_placeholder: "Les recommandations apparaîtront après calcul...",
      bm_hdr_indicator: "Indicateur",
      bm_hdr_current: "Valeur actuelle",
      bm_hdr_dz: "Benchmark Algérie",
      bm_hdr_intl: "Benchmark International",
      bm_hdr_status: "Statut",
      pdf_title: "Générer rapport PDF",
      pdf_include_params: "Paramètres",
      pdf_include_results: "Résultats",
      pdf_generate: "Générer PDF",
      cancel: "Annuler",
      cmp_title: "Comparaison de scénarios",
      cmp_help: "Sélectionnez jusqu'à 3 scénarios :",
      cmp_compare: "Comparer",
      res_eggs_total: "Œufs totaux (cycle)",
      res_trays_30: "Plateaux (30 œufs)",
      res_ca_total: "Chiffre d'affaires total",
      res_total_cost: "Coût total (cycle)",
      res_net_profit: "Bénéfice net",
      res_margin_pct: "Marge (%)",
      res_break_even: "Seuil rentabilité (DA/œuf)",
      res_roi: "ROI (%)",
      res_ephh: "Œufs / poule logée (EPHH)",
      res_avg_laying: "Ponte moyenne (%)",
      res_feed_total: "Aliment total",
      res_feed_per_egg: "Consommation / œuf",
      res_cost_per_egg: "Coût / œuf",
      res_profit_per_hen: "Bénéfice / poule",
      res_cost_pullets: "Achat poulettes",
      res_cost_feed: "Alimentation",
      res_cost_health: "Santé & vaccination",
      res_cost_labor: "Main d'œuvre",
      res_cost_energy: "Énergie",
      res_cost_other: "Location + autres",
      res_sens_egg_plus: "Marge si prix œuf +10%",
      res_sens_egg_minus: "Marge si prix œuf -10%",
      res_sens_feed_plus: "Marge si coût aliment +10%",
      res_sens_mort_plus: "Marge si mortalité +2%",
      res_days: "Durée cycle",
      res_eggs_per_day: "Œufs/jour moyen",
      res_ca_per_day: "CA/jour moyen",
      res_cost_per_day: "Coût/jour moyen",
      res_profit_per_day: "Marge/jour moyen",
      inst_laying_pct: "% ponte (t)",
      inst_eggs_day: "Œufs/jour",
      inst_feed_day: "Aliment/jour",
      inst_ca_day: "CA/jour",
      inst_feed_cost_day: "Coût aliment/jour",
      inst_gross_margin_day: "Marge brute/jour",
      fx_rate: "Taux de change"
    };

    I18N.ar = {
      title_main: "AviMetric PP",
      subtitle: "الحاسبة التقنية والاقتصادية للدجاج البياض",
      brand: "البحث والتطوير في تغذية الحيوانات",
      btn_reset: "القيم الافتراضية",
      btn_save: "حفظ",
      btn_compare: "مقارنة",
      btn_pdf: "تقرير PDF",
      btn_instant: "حساب لحظي",
      tab_params: "الإعدادات",
      tab_results: "النتائج",
      tab_analysis: "التحليلات",
      tab_benchmarks: "مقارنات",
      sec_base: "I. المتغيرات الأساسية",
      sec_prod: "II. الإنتاج والبيع",
      sec_costs: "III. التكاليف",
      sec_adv: "إعدادات متقدمة",
      calc_btn: "حساب الدورة",
      refresh_charts: "تحديث الرسوم",
      instant_title: "حساب لحظي (اليوم / الأسبوع)",
      instant_help: "اختر أسبوعًا أو يومًا.",
      instant_week: "الأسبوع (t)",
      instant_day: "اليوم (j)",
      use_observed: "استخدام قيم مُلاحظة",
      obs_laying: "نسبة البيض (%)",
      obs_feed: "استهلاك العلف (غ)",
      run_instant: "حساب",
      close: "إغلاق",
      dash_eggs_cycle: "إجمالي البيض (الدورة)",
      dash_ca: "رقم الأعمال",
      dash_profit: "صافي الربح",
      dash_feed_total: "إجمالي العلف",
      lbl_housed_hens: "عدد الدجاج المُسكن",
      lbl_cum_mortality: "النفوق التراكمي",
      lbl_age_start: "عمر بداية الإنتاج",
      lbl_age_end: "عمر نهاية الدورة",
      lbl_pullet_price: "سعر شراء البوليّت",
      lbl_egg_price: "سعر بيع البيضة",
      lbl_peak_model: "ذروة الإنتاج (النموذج)",
      lbl_peak_week: "أسبوع الذروة",
      lbl_decline: "الانخفاض بعد الذروة",
      lbl_daily_feed: "الاستهلاك اليومي",
      lbl_feed_price: "سعر العلف",
      lbl_feed_coef: "معامل تغير الاستهلاك",
      lbl_rent: "إيجار المبنى",
      lbl_labor: "اليد العاملة",
      lbl_energy: "الطاقة",
      lbl_health_per_hen: "الصحة (دج/دجاجة)",
      lbl_other_fees: "مصاريف أخرى",
      lbl_water_cost: "تكلفة الماء",
      lbl_insurance: "التأمين",
      lbl_bank_fees: "رسوم بنكية",
      lbl_vet_extra: "مصاريف بيطرية إضافية",
      unit_heads: "رؤوس",
      unit_weeks: "أسبوع",
      unit_days: "يوم",
      unit_da: "دج",
      unit_da_per_egg: "دج/بيضة",
      unit_da_per_kg: "دج/كغ",
      unit_pct_per_week: "٪/أسبوع",
      unit_g_per_day: "غ/يوم",
      unit_coef: "معامل",
      unit_pct: "٪",
      unit_g: "غ",
      unit_kg: "كغ",
      hdr_econ_summary: "ملخص اقتصادي",
      hdr_tech_indicators: "مؤشرات تقنية",
      hdr_cost_breakdown: "توزيع التكاليف",
      hdr_sensitivity: "تحليل الحساسية",
      hdr_yields: "المردودية",
      tab_results_cycle: "نتائج الدورة",
      instant_results: "نتائج فورية",
      bm_recommended: "مؤشرات موصى بها",
      bm_recommendations: "توصيات",
      bm_reco_placeholder: "ستظهر التوصيات بعد الحساب...",
      bm_hdr_indicator: "المؤشر",
      bm_hdr_current: "القيمة الحالية",
      bm_hdr_dz: "مرجع الجزائر",
      bm_hdr_intl: "مرجع دولي",
      bm_hdr_status: "الحالة",
      pdf_title: "إنشاء تقرير PDF",
      pdf_include_params: "الإعدادات",
      pdf_include_results: "النتائج",
      pdf_generate: "إنشاء PDF",
      cancel: "إلغاء",
      cmp_title: "مقارنة السيناريوهات",
      cmp_help: "اختر حتى 3 سيناريوهات:",
      cmp_compare: "مقارنة",
      res_eggs_total: "إجمالي البيض (الدورة)",
      res_trays_30: "أطباق (30 بيضة)",
      res_ca_total: "إجمالي رقم الأعمال",
      res_total_cost: "إجمالي التكلفة (الدورة)",
      res_net_profit: "صافي الربح",
      res_margin_pct: "الهامش (%)",
      res_break_even: "سعر التعادل (دج/بيضة)",
      res_roi: "العائد على الاستثمار (%)",
      res_ephh: "بيض/دجاجة مُسكنة (EPHH)",
      res_avg_laying: "متوسط الإنتاج (%)",
      res_feed_total: "إجمالي العلف",
      res_feed_per_egg: "استهلاك/بيضة",
      res_cost_per_egg: "تكلفة/بيضة",
      res_profit_per_hen: "ربح/دجاجة",
      res_cost_pullets: "شراء البوليّت",
      res_cost_feed: "العلف",
      res_cost_health: "الصحة والتلقيح",
      res_cost_labor: "اليد العاملة",
      res_cost_energy: "الطاقة",
      res_cost_other: "الإيجار + أخرى",
      res_sens_egg_plus: "الهامش إذا ارتفع سعر البيضة 10%",
      res_sens_egg_minus: "الهامش إذا انخفض سعر البيضة 10%",
      res_sens_feed_plus: "الهامش إذا ارتفعت تكلفة العلف 10%",
      res_sens_mort_plus: "الهامش إذا زاد النفوق 2%",
      res_days: "مدة الدورة",
      res_eggs_per_day: "متوسط البيض/يوم",
      res_ca_per_day: "متوسط رقم الأعمال/يوم",
      res_cost_per_day: "متوسط التكلفة/يوم",
      res_profit_per_day: "متوسط الهامش/يوم",
      inst_laying_pct: "نسبة الإنتاج (t)",
      inst_eggs_day: "بيض/يوم",
      inst_feed_day: "علف/يوم",
      inst_ca_day: "رقم الأعمال/يوم",
      inst_feed_cost_day: "تكلفة العلف/يوم",
      inst_gross_margin_day: "هامش إجمالي/يوم",
      fx_rate: "سعر الصرف"
    };

    I18N.en = {
      title_main: "AviMetric PP",
      subtitle: "Layer Poultry Techno-Economic Calculator",
      brand: "Animal Nutrition R&D",
      btn_reset: "Default Values",
      btn_save: "Save",
      btn_compare: "Compare",
      btn_pdf: "PDF Report",
      btn_instant: "Instant Calc",
      tab_params: "Parameters",
      tab_results: "Results",
      tab_analysis: "Analysis",
      tab_benchmarks: "Benchmarks",
      sec_base: "I. Basic Variables",
      sec_prod: "II. Production & Sales",
      sec_costs: "III. Indirect Costs",
      sec_adv: "Advanced Settings",
      calc_btn: "Calculate Cycle",
      refresh_charts: "Refresh Charts",
      instant_title: "Instant Calc (Day / Week)",
      instant_help: "Select a week or day in the cycle.",
      instant_week: "Week (t)",
      instant_day: "Day (j)",
      use_observed: "Use Observed Values",
      obs_laying: "Observed Laying (%)",
      obs_feed: "Observed Feed (g/d)",
      run_instant: "Calculate",
      close: "Close",
      dash_eggs_cycle: "Total eggs (cycle)",
      dash_ca: "Revenue",
      dash_profit: "Net profit",
      dash_feed_total: "Total feed",
      lbl_housed_hens: "Housed hens",
      lbl_cum_mortality: "Cumulative mortality",
      lbl_age_start: "Start age of lay",
      lbl_age_end: "End of cycle age",
      lbl_pullet_price: "Pullet purchase price",
      lbl_egg_price: "Egg selling price",
      lbl_peak_model: "Peak lay (model)",
      lbl_peak_week: "Peak week",
      lbl_decline: "Post-peak decline",
      lbl_daily_feed: "Daily feed intake",
      lbl_feed_price: "Feed price",
      lbl_feed_coef: "Feed variation coefficient",
      lbl_rent: "Building rent",
      lbl_labor: "Labor",
      lbl_energy: "Energy",
      lbl_health_per_hen: "Health (DA/hen)",
      lbl_other_fees: "Other fees",
      lbl_water_cost: "Water cost",
      lbl_insurance: "Insurance",
      lbl_bank_fees: "Bank fees",
      lbl_vet_extra: "Extra veterinary fees",
      unit_heads: "heads",
      unit_weeks: "wk",
      unit_days: "d",
      unit_da: "DA",
      unit_da_per_egg: "DA/egg",
      unit_da_per_kg: "DA/kg",
      unit_pct_per_week: "%/wk",
      unit_g_per_day: "g/d",
      unit_coef: "coef",
      unit_pct: "%",
      unit_g: "g",
      unit_kg: "kg",
      hdr_econ_summary: "Economic summary",
      hdr_tech_indicators: "Technical indicators",
      hdr_cost_breakdown: "Cost breakdown",
      hdr_sensitivity: "Sensitivity analysis",
      hdr_yields: "Yields",
      tab_results_cycle: "Cycle results",
      instant_results: "Instant results",
      bm_recommended: "Recommended indicators",
      bm_recommendations: "Recommendations",
      bm_reco_placeholder: "Recommendations will appear after calculation...",
      bm_hdr_indicator: "Indicator",
      bm_hdr_current: "Current value",
      bm_hdr_dz: "Algeria benchmark",
      bm_hdr_intl: "International benchmark",
      bm_hdr_status: "Status",
      pdf_title: "Generate PDF report",
      pdf_include_params: "Parameters",
      pdf_include_results: "Results",
      pdf_generate: "Generate PDF",
      cancel: "Cancel",
      cmp_title: "Scenario comparison",
      cmp_help: "Select up to 3 scenarios:",
      cmp_compare: "Compare",
      res_eggs_total: "Total eggs (cycle)",
      res_trays_30: "Trays (30 eggs)",
      res_ca_total: "Total revenue",
      res_total_cost: "Total cost (cycle)",
      res_net_profit: "Net profit",
      res_margin_pct: "Margin (%)",
      res_break_even: "Break-even (DA/egg)",
      res_roi: "ROI (%)",
      res_ephh: "Eggs/hen housed (EPHH)",
      res_avg_laying: "Average laying (%)",
      res_feed_total: "Total feed",
      res_feed_per_egg: "Feed per egg",
      res_cost_per_egg: "Cost per egg",
      res_profit_per_hen: "Profit per hen",
      res_cost_pullets: "Pullets",
      res_cost_feed: "Feed",
      res_cost_health: "Health & vaccination",
      res_cost_labor: "Labor",
      res_cost_energy: "Energy",
      res_cost_other: "Rent + other",
      res_sens_egg_plus: "Margin if egg price +10%",
      res_sens_egg_minus: "Margin if egg price -10%",
      res_sens_feed_plus: "Margin if feed cost +10%",
      res_sens_mort_plus: "Margin if mortality +2%",
      res_days: "Cycle duration",
      res_eggs_per_day: "Avg eggs/day",
      res_ca_per_day: "Avg revenue/day",
      res_cost_per_day: "Avg cost/day",
      res_profit_per_day: "Avg margin/day",
      inst_laying_pct: "Laying % (t)",
      inst_eggs_day: "Eggs/day",
      inst_feed_day: "Feed/day",
      inst_ca_day: "Revenue/day",
      inst_feed_cost_day: "Feed cost/day",
      inst_gross_margin_day: "Gross margin/day",
      fx_rate: "Exchange rate"
    };

    function applyLanguage(){
      document.documentElement.lang = INOIA_LANG;
      document.body.setAttribute("dir", INOIA_LANG === "ar" ? "rtl" : "ltr");
      const langBtn = document.getElementById("langSwitcher");
      if (langBtn) langBtn.innerText = INOIA_LANG.toUpperCase();
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        if (I18N[INOIA_LANG][k]) el.innerText = I18N[INOIA_LANG][k];
      });
      refreshCurrencyUnits();
      updateFxUI();
    }
    
    function switchLanguage(){
      let idx = langs.indexOf(INOIA_LANG);
      INOIA_LANG = langs[(idx + 1) % langs.length];
      applyLanguage();
      updateFxUI();
      calculerCycle(true);
    }
  
// --- Currency / Formatting ---
const currencies = ["DZD","EUR","USD"];
let INOIA_CURRENCY = localStorage.getItem("inoia_currency") || "DZD";
// Store FX as: { "EUR": dzdPerUnit, "USD": dzdPerUnit }  (example: 1 EUR = 250 DZD)
let INOIA_FX_DZD_PER_UNIT = {};
try { INOIA_FX_DZD_PER_UNIT = JSON.parse(localStorage.getItem("inoia_fx_dzd_per_unit")||"{}")||{}; } catch(e){ INOIA_FX_DZD_PER_UNIT = {}; }
INOIA_FX_DZD_PER_UNIT.DZD = 1;

// Money inputs that should follow selected currency (values + units)
const MONEY_INPUT_IDS = ["prixPoullette","prixOeuf","prixAliment","location","mainOeuvre","energie","santeParPoule","autresFrais","coutEau","assurance","fraisBancaires","fraisVeterinaire","instantDay"];

function parseNum(val){
  const s = String(val ?? "").replace(/\s/g,"").replace(",",".");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function dzdPerUnitFor(cur){
  if(cur==="DZD") return 1;
  const v = getDzdPerUnit(cur);
  return v ? v : null;
}

// Read a money input as DZD (based on CURRENT displayed currency)
function moneyValDzd(id){
  const el = document.getElementById(id);
  if(!el) return 0;
  const v = parseNum(el.value);
  const rate = dzdPerUnitFor(INOIA_CURRENCY);
  if(!rate) return v; // fallback
  return v * rate;
}

// Convert current displayed money inputs from one currency to another (keeps underlying DZD constant)
function convertMoneyInputs(oldCur, newCur){
  const oldRate = dzdPerUnitFor(oldCur);
  const newRate = dzdPerUnitFor(newCur);
  if(!oldRate || !newRate) return;
  MONEY_INPUT_IDS.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const oldDisplayed = parseNum(el.value);
    const amountDzd = oldDisplayed * oldRate;
    const newDisplayed = amountDzd / newRate;
    // Keep decimals if step suggests it, otherwise 0
    const step = el.getAttribute("step");
    const dec = (step && String(step).includes(".")) ? (String(step).split(".")[1].length) : 0;
    el.value = (dec>0) ? Number(newDisplayed).toFixed(dec) : Math.round(newDisplayed).toString();
  });
}

function unitTextForKey(key){
  const sym = moneyLabel();
  if(key==="unit_da") return sym;
  if(key==="unit_da_per_egg") return sym + "/u";
  if(key==="unit_da_per_kg") return sym + "/kg";
  return sym;
}

function refreshCurrencyUnits(){
  // Units next to inputs
  document.querySelectorAll('[data-i18n="unit_da"],[data-i18n="unit_da_per_egg"],[data-i18n="unit_da_per_kg"]').forEach(el=>{
    el.textContent = unitTextForKey(el.getAttribute("data-i18n"));
  });
  // Dashboard units (if any are still static spans)
  document.querySelectorAll(".dashboard-unit").forEach(el=>{
    el.textContent = moneyLabel();
  });
}



function updateFxUI(){
  const box = document.getElementById("fxBox");
  const inp = document.getElementById("fxRateInput");
  const title = document.getElementById("fxTitle");
  const cur = document.getElementById("fxCur");
  if(!box || !inp || !title || !cur) return;

  if(INOIA_CURRENCY === "DZD"){
    box.style.display = "none";
    return;
  }
  box.style.display = "flex";
  title.textContent = (I18N[INOIA_LANG] && I18N[INOIA_LANG].fx_rate) ? I18N[INOIA_LANG].fx_rate : (INOIA_LANG==="ar" ? "سعر الصرف" : "Taux de change");
  cur.textContent = INOIA_CURRENCY;

  const v = getDzdPerUnit(INOIA_CURRENCY);
  inp.value = (v && Number.isFinite(v)) ? v : "";
}

function setFxRateFromInput(){
  if(INOIA_CURRENCY === "DZD") return;
  const inp = document.getElementById("fxRateInput");
  if(!inp) return;
  const num = Number(String(inp.value).replace(",",".").trim());
  if(!Number.isFinite(num) || num<=0){
    // keep previous value, just ignore
    return;
  }
  INOIA_FX_DZD_PER_UNIT[INOIA_CURRENCY] = num;
  localStorage.setItem("inoia_fx_dzd_per_unit", JSON.stringify(INOIA_FX_DZD_PER_UNIT));
  calculerCycle(true);
}

document.addEventListener("input", (e)=>{
  if(e && e.target && e.target.id === "fxRateInput"){
    setFxRateFromInput();
  }
});

function getDzdPerUnit(cur){
  if(cur==="DZD") return 1;
  const v = Number(INOIA_FX_DZD_PER_UNIT[cur]);
  return (Number.isFinite(v) && v>0) ? v : null;
}

function askFxIfMissing(cur){
  if(cur==="DZD") return true;
  if(getDzdPerUnit(cur)) return true;
  const label = (cur==="EUR") ? "EUR (€)" : (cur==="USD") ? "USD ($)" : cur;
  const msg = (INOIA_LANG==="ar")
    ? `أدخل سعر الصرف: كم دج لكل 1 ${label} ؟
مثال: 250`
    : `Entrez le taux de change: combien de DZD pour 1 ${label} ?
Ex: 250`;
  const val = prompt(msg,"");
  if(val===null) return false;
  const num = Number(String(val).replace(",",".").trim());
  if(!Number.isFinite(num) || num<=0){
    showNotification((INOIA_LANG==="ar") ? "سعر صرف غير صالح." : "Taux de change invalide.","error");
    return false;
  }
  INOIA_FX_DZD_PER_UNIT[cur]=num;
  localStorage.setItem("inoia_fx_dzd_per_unit", JSON.stringify(INOIA_FX_DZD_PER_UNIT));
  return true;
}

function applyCurrency(){
  const el = document.getElementById("currencySwitcher");
  if(el) el.textContent = INOIA_CURRENCY;
  localStorage.setItem("inoia_currency", INOIA_CURRENCY);
  refreshCurrencyUnits();
  updateFxUI();
  calculerCycle(true);
}

function switchCurrency(){
  const idx = currencies.indexOf(INOIA_CURRENCY);
  const next = currencies[(idx+1) % currencies.length];
  if(!askFxIfMissing(next)) return;
  const prev = INOIA_CURRENCY;
  // Convert all money inputs so their real value stays the same when changing currency
  convertMoneyInputs(prev, next);
  INOIA_CURRENCY = next;
  applyCurrency();
}

function moneyLabel(){
  // Keep labels stable & simple (no symbol confusion in RTL)
  if(INOIA_CURRENCY==="DZD") return (INOIA_LANG==="ar") ? "دج" : "DA";
  if(INOIA_CURRENCY==="EUR") return "€";
  if(INOIA_CURRENCY==="USD") return "$";
  return INOIA_CURRENCY;
}

function convertFromDzd(amountDzd){
  if(INOIA_CURRENCY==="DZD") return amountDzd;
  const dzdPerUnit = getDzdPerUnit(INOIA_CURRENCY);
  if(!dzdPerUnit) return amountDzd; // fallback
  return amountDzd / dzdPerUnit;
}

function fmtMoney(amountDzd, dec=0, suffix=""){
  const v = convertFromDzd(Number(amountDzd)||0);
  const lbl = moneyLabel();
  // Example: 1 000 DA  /  4 000 €/kg
  return `${fmtNumber(v,dec)} ${lbl}${suffix}`;
}

function renderDashMoney(amountDzd, dec=0){
  const v = convertFromDzd(Number(amountDzd)||0);
  const lbl = moneyLabel();
  return `${fmtNumber(v,dec)} <span class="dashboard-unit">${lbl}</span>`;
}
  </script>
</head>

<body onload="initApp()">
  <div class="container">
    <header class="header">
      <img src="logo.png" alt="Logo Inoiatech" class="logo-img" onerror="this.style.display='none'">
      <h1 data-i18n="title_main">AviMetric PP</h1>
      <p class="subtitle" data-i18n="subtitle">Calculateur technicoéconomique pour poule pondeuse</p>
      
      <div class="action-buttons">
        <button class="action-btn btn-reset" onclick="switchLanguage()"><i class="fas fa-globe"></i> <span id="langSwitcher">FR</span></button>
        <button class="action-btn btn-reset" onclick="switchCurrency()"><i class="fas fa-coins"></i> <span id="currencySwitcher">DZD</span></button>

        
<button class="action-btn btn-pdf" onclick="showPDFModal()"><i class="fas fa-file-pdf"></i> <span data-i18n="btn_pdf">Rapport</span></button>
        <button class="action-btn btn-compare" onclick="openInstantModal()"><i class="fas fa-bolt"></i> <span data-i18n="btn_instant">Instant.</span></button>
        <button class="action-btn btn-reset" onclick="resetToDefaults()"><i class="fas fa-redo"></i> <span data-i18n="btn_reset">Reset</span></button>
        <button class="action-btn btn-save" onclick="calculerCycle()"><i class="fas fa-calculator"></i> <span data-i18n="calc_btn">Calculer</span></button>
      </div>
    </header>

    <div class="dashboard">
      <div class="dashboard-card">
        <div class="dashboard-icon"><i class="fas fa-egg"></i></div>
        <div class="dashboard-value" id="dashboard-eggs">0</div>
        <div class="dashboard-label">Œufs totaux (cycle)</div>
      </div>
      <div class="dashboard-card">
        <div class="dashboard-icon"><i class="fas fa-money-bill-wave"></i></div>
        <div class="dashboard-value" id="dashboard-ca">0 <span class="dashboard-unit">DA</span></div>
        <div class="dashboard-label">Chiffre d'affaires</div>
      </div>
      <div class="dashboard-card">
        <div class="dashboard-icon"><i class="fas fa-chart-line"></i></div>
        <div class="dashboard-value" id="dashboard-profit">0 <span class="dashboard-unit">DA</span></div>
        <div class="dashboard-label">Bénéfice net</div>
      </div>
      <div class="dashboard-card">
        <div class="dashboard-icon"><i class="fas fa-seedling"></i></div>
        <div class="dashboard-value" id="dashboard-feed">0 <span class="dashboard-unit">kg</span></div>
        <div class="dashboard-label">Aliment total</div>
      </div>
    </div>

    <div class="tabs" id="mainTabs">
      <div class="tab active" onclick="switchTab('tab-parametres')"><i class="fas fa-sliders-h"></i> <span data-i18n="tab_params">Paramètres</span></div>
      <div class="tab" onclick="switchTab('tab-resultats')"><i class="fas fa-chart-bar"></i> <span data-i18n="tab_results">Résultats</span></div>
<div class="tab" onclick="switchTab('tab-benchmarks')"><i class="fas fa-trophy"></i> <span data-i18n="tab_benchmarks">Benchmarks</span></div>
    </div>

    <div class="tab-content active" id="tab-parametres">
      <div class="content">
        <div class="column">
          <section class="section">
            <h2 class="section-title"><i class="fas fa-info-circle"></i> <span data-i18n="sec_base">I. Variables de Base</span></h2>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="nombrePoules"><span data-i18n="lbl_housed_hens">Nombre de poules logées</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="nombrePoules" min="1" value="10000"><span class="unit"><span data-i18n="unit_heads">têtes</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="mortaliteCycle"><span data-i18n="lbl_cum_mortality">Mortalité cumulée</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="mortaliteCycle" min="0" max="30" step="0.1" value="6"><span class="unit"><span data-i18n="unit_pct">%</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="ageDebut"><span data-i18n="lbl_age_start">Âge début de ponte</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="ageDebut" min="16" max="30" value="20"><span class="unit"><span data-i18n="unit_weeks">sem</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="ageFin"><span data-i18n="lbl_age_end">Âge fin de cycle</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="ageFin" min="40" max="110" value="80"><span class="unit"><span data-i18n="unit_weeks">sem</span></span></div>
              </div>
            </div>
          </section>

          <section class="section">
            <h2 class="section-title"><i class="fas fa-egg"></i> <span data-i18n="sec_prod">II. Production & Vente</span></h2>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="prixPoullette"><span data-i18n="lbl_pullet_price">Prix d'achat poulette</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="prixPoullette" min="0" step="1" value="850"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="prixOeuf"><span data-i18n="lbl_egg_price">Prix de vente œuf</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="prixOeuf" min="0" step="0.1" value="17"><span class="unit"><span data-i18n="unit_da_per_egg">DA/u</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="modelePic"><span data-i18n="lbl_peak_model">Ponte pic (modèle)</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="modelePic" min="70" max="98" step="0.1" value="93"><span class="unit"><span data-i18n="unit_pct">%</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="semainePic"><span data-i18n="lbl_peak_week">Semaine du pic</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="semainePic" min="20" max="50" value="30"><span class="unit"><span data-i18n="unit_weeks">sem</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="declinHebdo"><span data-i18n="lbl_decline">Déclin après pic</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="declinHebdo" min="0" max="2" step="0.01" value="0.35"><span class="unit"><span data-i18n="unit_pct_per_week">%/sem</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="consoJour"><span data-i18n="lbl_daily_feed">Conso journalière</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="consoJour" min="70" max="140" step="1" value="110"><span class="unit"><span data-i18n="unit_g_per_day">g/j</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="prixAliment"><span data-i18n="lbl_feed_price">Prix aliment</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="prixAliment" min="0" step="0.1" value="72"><span class="unit"><span data-i18n="unit_da_per_kg">DA/kg</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="coefConsoPic"><span data-i18n="lbl_feed_coef">Coef variation conso</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="coefConsoPic" min="0" max="0.5" step="0.01" value="0.12"><span class="unit"><span data-i18n="unit_coef">coef</span></span></div>
              </div>
            </div>
          </section>
        </div>

        <div class="column">
          <section class="section">
            <h2 class="section-title"><i class="fas fa-calculator"></i> <span data-i18n="sec_costs">III. Charges Indirectes</span></h2>
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label" for="location"><span data-i18n="lbl_rent">Location bâtiment</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="location" min="0" value="400000"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="mainOeuvre"><span data-i18n="lbl_labor">Main d'œuvre</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="mainOeuvre" min="0" value="550000"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="energie"><span data-i18n="lbl_energy">Énergie</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="energie" min="0" value="200000"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="santeParPoule"><span data-i18n="lbl_health_per_hen">Santé (DA/poule)</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="santeParPoule" min="0" step="1" value="120"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
              </div>
              <div class="form-group">
                <label class="form-label" for="autresFrais"><span data-i18n="lbl_other_fees">Autres frais</span></label>
                <div class="input-with-unit"><input type="number" class="form-input" id="autresFrais" min="0" value="180000"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
              </div>
            </div>
          </section>

          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <label style="font-weight:900;color:var(--primary-color);display:flex;align-items:center;gap:10px;">
              <input type="checkbox" id="advancedToggle" style="width:20px;height:20px;">
              <span data-i18n="sec_adv">Paramètres avancés</span>
            </label>
          </div>

          <div id="advancedOptions" style="display:none;">
            <section class="section">
              <h2 class="section-title"><i class="fas fa-cogs"></i> <span data-i18n="sec_adv">Paramètres avancés</span></h2>
              <div class="form-grid">
                <!-- FX rate (only when currency != DZD) -->
                <div class="fx-box" id="fxBox">
                          <span class="fx-title" id="fxTitle">Taux</span>
                          <span class="fx-label">1</span>
                          <span class="fx-cur" id="fxCur">EUR</span>
                          <span class="fx-label">=</span>
                          <input type="number" id="fxRateInput" min="0" step="0.01" inputmode="decimal" />
                          <span class="fx-label">DZD</span>
                        </div>
                
                        

                <div class="form-group">
                  <label class="form-label" for="coutEau"><span data-i18n="lbl_water_cost">Coût de l'eau</span></label>
                  <div class="input-with-unit"><input type="number" class="form-input" id="coutEau" min="0" value="60000"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
                </div>
                <div class="form-group">
                  <label class="form-label" for="assurance"><span data-i18n="lbl_insurance">Assurance</span></label>
                  <div class="input-with-unit"><input type="number" class="form-input" id="assurance" min="0" value="70000"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
                </div>
                <div class="form-group">
                  <label class="form-label" for="fraisBancaires"><span data-i18n="lbl_bank_fees">Frais bancaires</span></label>
                  <div class="input-with-unit"><input type="number" class="form-input" id="fraisBancaires" min="0" value="35000"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
                </div>
                <div class="form-group">
                  <label class="form-label" for="fraisVeterinaire"><span data-i18n="lbl_vet_extra">Frais vétérinaires sup.</span></label>
                  <div class="input-with-unit"><input type="number" class="form-input" id="fraisVeterinaire" min="0" value="0"><span class="unit"><span data-i18n="unit_da">DA</span></span></div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tab-resultats">
      <section class="section">
        <h2 class="section-title"><i class="fas fa-chart-bar"></i> <span data-i18n="tab_results"><span data-i18n="tab_results_cycle">Résultats cycle</span></span></h2>

        <div class="form-grid" style="margin-bottom:22px;">
          <div class="form-group">
            <h3 style="color:var(--primary-color);margin-bottom:12px;font-weight:900;"><span data-i18n="hdr_econ_summary">Synthèse économique</span></h3>
            <table class="results-table">
              <tr><td><span data-i18n="res_eggs_total">Œufs totaux (cycle)</span></td><td class="value" id="resultEggs">0</td></tr>
              <tr><td><span data-i18n="res_trays_30">Plateaux (30 œufs)</span></td><td class="value" id="resultTrays">0</td></tr>
              <tr><td><span data-i18n="res_ca_total">Chiffre d'affaires total</span></td><td class="value" id="resultCA">0 DA</td></tr>
              <tr><td><span data-i18n="res_total_cost">Coût total (cycle)</span></td><td class="value" id="resultCoutTotal">0 DA</td></tr>
              <tr style="font-weight:900;background:#f8f9fa;"><td><span data-i18n="res_net_profit">Bénéfice net</span></td><td class="value" id="resultBenefice">0 DA</td></tr>
              <tr><td><span data-i18n="res_margin_pct">Marge (%)</span></td><td class="value" id="resultMargePourcentage">0%</td></tr>
              <tr><td><span data-i18n="res_break_even">Seuil rentabilité (DA/œuf)</span></td><td class="value" id="resultSeuil">0</td></tr>
              <tr><td><span data-i18n="res_roi">ROI (%)</span></td><td class="value" id="resultROI">0%</td></tr>
            </table>
          </div>

          <div class="form-group">
            <h3 style="color:var(--primary-color);margin-bottom:12px;font-weight:900;"><span data-i18n="hdr_tech_indicators">Indicateurs techniques</span></h3>
            <table class="results-table">
              <tr><td><span data-i18n="res_ephh">Œufs / poule logée (EPHH)</span></td><td class="value" id="resultEPHH">0</td></tr>
              <tr><td><span data-i18n="res_avg_laying">Ponte moyenne (%)</span></td><td class="value" id="resultLayingAvg">0%</td></tr>
              <tr><td><span data-i18n="res_feed_total">Aliment total</span></td><td class="value" id="resultFeedKg">0 kg</td></tr>
              <tr><td><span data-i18n="res_feed_per_egg">Consommation / œuf</span></td><td class="value" id="resultFeedPerEgg">0 g/œuf</td></tr>
              <tr><td><span data-i18n="res_cost_per_egg">Coût / œuf</span></td><td class="value" id="resultCostPerEgg">0 DA/œuf</td></tr>
              <tr><td><span data-i18n="res_profit_per_hen">Bénéfice / poule</span></td><td class="value" id="resultProfitHen">0 DA</td></tr>
            </table>
          </div>
        </div>

        <h3 style="color:var(--primary-color);margin:10px 0 10px 0;font-weight:900;"><span data-i18n="hdr_cost_breakdown">Répartition des coûts</span></h3>
        <div class="form-grid">
          <div class="form-group">
            <table class="results-table">
              <tr><td><span data-i18n="res_cost_pullets">Achat poulettes</span></td><td class="value" id="resultCostPullets">0 DA</td><td class="value" id="resultCostPulletsPct">0%</td></tr>
              <tr><td><span data-i18n="res_cost_feed">Alimentation</span></td><td class="value" id="resultCostFeed">0 DA</td><td class="value" id="resultCostFeedPct">0%</td></tr>
              <tr><td><span data-i18n="res_cost_health">Santé & vaccination</span></td><td class="value" id="resultCostHealth">0 DA</td><td class="value" id="resultCostHealthPct">0%</td></tr>
            </table>
          </div>
          <div class="form-group">
            <table class="results-table">
              <tr><td><span data-i18n="res_cost_labor">Main d'œuvre</span></td><td class="value" id="resultCostLabour">0 DA</td><td class="value" id="resultCostLabourPct">0%</td></tr>
              <tr><td><span data-i18n="res_cost_energy">Énergie</span></td><td class="value" id="resultCostEnergy">0 DA</td><td class="value" id="resultCostEnergyPct">0%</td></tr>
              <tr><td><span data-i18n="res_cost_other">Location + autres</span></td><td class="value" id="resultCostOther">0 DA</td><td class="value" id="resultCostOtherPct">0%</td></tr>
            </table>
          </div>
        </div>

        <div class="form-grid" style="margin-top:18px;">
          <div class="form-group">
            <h3 style="color:var(--primary-color);margin-bottom:12px;font-weight:900;"><span data-i18n="hdr_sensitivity">Analyse de sensibilité</span></h3>
            <table class="results-table">
              <tr><td><span data-i18n="res_sens_egg_plus">Marge si prix œuf +10%</span></td><td class="value" id="resultSensEggPlus">0 DA</td><td class="value" id="resultSensEggPlusPct">0%</td></tr>
              <tr><td><span data-i18n="res_sens_egg_minus">Marge si prix œuf -10%</span></td><td class="value" id="resultSensEggMinus">0 DA</td><td class="value" id="resultSensEggMinusPct">0%</td></tr>
              <tr><td><span data-i18n="res_sens_feed_plus">Marge si coût aliment +10%</span></td><td class="value" id="resultSensFeedPlus">0 DA</td><td class="value" id="resultSensFeedPlusPct">0%</td></tr>
              <tr><td><span data-i18n="res_sens_mort_plus">Marge si mortalité +2%</span></td><td class="value" id="resultSensMortPlus">0 DA</td><td class="value" id="resultSensMortPlusPct">0%</td></tr>
            </table>
          </div>

          <div class="form-group">
            <h3 style="color:var(--primary-color);margin-bottom:12px;font-weight:900;"><span data-i18n="hdr_yields">Rendements</span></h3>
            <table class="results-table">
              <tr><td><span data-i18n="res_days">Durée cycle</span></td><td class="value" id="resultDays">0 j</td></tr>
              <tr><td><span data-i18n="res_eggs_per_day">Œufs/jour moyen</span></td><td class="value" id="resultEggsPerDay">0</td></tr>
              <tr><td><span data-i18n="res_ca_per_day">CA/jour moyen</span></td><td class="value" id="resultCAperDay">0 DA</td></tr>
              <tr><td><span data-i18n="res_cost_per_day">Coût/jour moyen</span></td><td class="value" id="resultCostPerDay">0 DA</td></tr>
              <tr><td><span data-i18n="res_profit_per_day">Marge/jour moyen</span></td><td class="value" id="resultProfitPerDay">0 DA</td></tr>
            </table>
          </div>
        </div>
      </section>
    </div>

    <div class="tab-content" id="tab-benchmarks">
      <section class="section">
        <h2 class="section-title"><i class="fas fa-trophy"></i> <span data-i18n="tab_benchmarks">Benchmarks</span></h2>
        <div class="form-grid">
          <div class="form-group">
            <h3 style="color:var(--primary-color);margin-bottom:12px;font-weight:900;"><span data-i18n="bm_recommended">Indicateurs recommandés</span></h3>
            <table class="benchmark-table">
              <thead>
                <tr><th><span data-i18n="bm_hdr_indicator">Indicateur</span></th><th><span data-i18n="bm_hdr_current">Valeur actuelle</span></th><th><span data-i18n="bm_hdr_dz">Benchmark Algérie</span></th><th><span data-i18n="bm_hdr_intl">Benchmark International</span></th><th><span data-i18n="bm_hdr_status">Statut</span></th></tr>
              </thead>
              <tbody>
                <tr><td>Œufs / poule logée (cycle)</td><td id="bmEggsHen">0</td><td>280 - 310</td><td>300 - 330</td><td id="bmEggsHenStatus" class="good">-</td></tr>
                <tr><td>Ponte pic (%)</td><td id="bmPeak">0%</td><td>90% - 94%</td><td>92% - 96%</td><td id="bmPeakStatus" class="good">-</td></tr>
                <tr><td>Consommation (g/j)</td><td id="bmFeed">0</td><td>105 - 115</td><td>100 - 112</td><td id="bmFeedStatus" class="good">-</td></tr>
                <tr><td>Consommation / œuf (g/œuf)</td><td id="bmFeedEgg">0</td><td>125 - 145</td><td>120 - 140</td><td id="bmFeedEggStatus" class="good">-</td></tr>
                <tr><td>Bénéfice / poule (cycle)</td><td id="bmProfitHen">0</td><td>+400 à +900</td><td>+600 à +1200</td><td id="bmProfitHenStatus" class="good">-</td></tr>
              </tbody>
            </table>
          </div>
          <div class="form-group">
            <h3 style="color:var(--primary-color);margin-bottom:12px;font-weight:900;"><span data-i18n="bm_recommendations">Recommandations</span></h3>
            <div id="recommendationsList" style="padding:15px;background:#f8f9fa;border-radius:8px;min-height:220px;">
              <p style="color:var(--text-light);font-style:italic;"><span data-i18n="bm_reco_placeholder">Les recommandations apparaîtront après calcul...</span></p>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="footer-sig">
        <div style="font-weight:800; font-size:1.2rem;">M.Sc Adlane Belouam</div>
        <div style="font-style:italic; color:#666;">Directeur Recherche & Développement</div>
        <div style="color:var(--primary-color); font-weight:bold;">Inoiatech Biocybernétiques – Algérie</div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <div id="pdfModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title"><i class="fas fa-file-pdf"></i> <span data-i18n="pdf_title">Générer rapport PDF</span></h2>
      <div style="margin-top:12px;">
        <div style="margin-bottom:10px;"><input type="checkbox" id="includeParameters" checked> <label for="includeParameters"><span data-i18n="pdf_include_params">Paramètres</span></label></div>
        <div style="margin-bottom:10px;"><input type="checkbox" id="includeResults" checked> <label for="includeResults"><span data-i18n="pdf_include_results">Résultats</span></label></div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="generatePDF()"><i class="fas fa-download"></i> Générer PDF</button>
        <button class="modal-btn cancel" onclick="closePDFModal()"><i class="fas fa-times"></i> Annuler</button>
      </div>
    </div>
  </div>

  <div id="comparisonModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title"><i class="fas fa-exchange-alt"></i> <span data-i18n="cmp_title">Comparaison de scénarios</span></h2>
      <p><span data-i18n="cmp_help">Sélectionnez jusqu'à 3 scénarios :</span></p>
      <div id="comparisonScenariosList" style="margin-top:12px;max-height:300px;overflow:auto;"></div>
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="compareScenarios()"><i class="fas fa-chart-bar"></i> Comparer</button>
        <button class="modal-btn cancel" onclick="closeComparisonModal()"><i class="fas fa-times"></i> Annuler</button>
      </div>
    </div>
  </div>

  <div id="instantModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title"><i class="fas fa-bolt"></i> <span data-i18n="instant_title">Calcul instantané</span></h2>
      <p data-i18n="instant_help">Choisissez une semaine ou un jour.</p>

      <div class="form-grid" style="margin-top:10px;">
        <div class="form-group">
          <label class="form-label" for="instantWeek" data-i18n="instant_week">Semaine (t)</label>
          <div class="input-with-unit"><input type="number" class="form-input" id="instantWeek" min="0" value="10"><span class="unit"><span data-i18n="unit_weeks">sem</span></span></div>
        </div>
        <div class="form-group">
          <label class="form-label" for="instantDay" data-i18n="instant_day">Jour (j)</label>
          <div class="input-with-unit"><input type="number" class="form-input" id="instantDay" min="0" value="70"><span class="unit"><span data-i18n="unit_days">j</span></span></div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px;margin-top:8px;">
        <label style="font-weight:900;color:var(--primary-color);display:flex;align-items:center;gap:10px;">
          <input type="checkbox" id="useObserved" style="width:20px;height:20px;">
          <span data-i18n="use_observed">Utiliser valeurs observées</span>
        </label>
      </div>

      <div id="observedBlock" style="display:none;margin-top:8px;">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label" for="observedLaying" data-i18n="obs_laying">Ponte observée (%)</label>
            <div class="input-with-unit"><input type="number" class="form-input" id="observedLaying" min="0" max="100" step="0.1" value="90"><span class="unit"><span data-i18n="unit_pct">%</span></span></div>
          </div>
          <div class="form-group">
            <label class="form-label" for="observedFeed" data-i18n="obs_feed">Conso observée (g/j)</label>
            <div class="input-with-unit"><input type="number" class="form-input" id="observedFeed" min="50" max="200" step="1" value="112"><span class="unit"><span data-i18n="unit_g">g</span></span></div>
          </div>
        </div>
      </div>

      <div class="section" style="margin-top:12px;padding:16px;">
        <h3 style="color:var(--primary-color);margin-bottom:10px;font-weight:900;"><span data-i18n="instant_results">Résultats instantanés</span></h3>
        <table class="results-table">
          <tr><td><span data-i18n="inst_laying_pct">% ponte (t)</span></td><td class="value" id="instLayingPct">-</td></tr>
          <tr><td><span data-i18n="inst_eggs_day">Œufs/jour</span></td><td class="value" id="instEggsDay">-</td></tr>
          <tr><td><span data-i18n="inst_feed_day">Aliment/jour</span></td><td class="value" id="instFeedDay">-</td></tr>
          <tr><td><span data-i18n="inst_ca_day">CA/jour</span></td><td class="value" id="instCAday">-</td></tr>
          <tr><td><span data-i18n="inst_feed_cost_day">Coût aliment/jour</span></td><td class="value" id="instFeedCostDay">-</td></tr>
          <tr style="font-weight:900;background:#f8f9fa;"><td><span data-i18n="inst_gross_margin_day">Marge brute/jour</span></td><td class="value" id="instMarginDay">-</td></tr>
        </table>
      </div>

      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="calculerInstant()"><i class="fas fa-bolt"></i> <span data-i18n="run_instant">Calculer</span></button>
        <button class="modal-btn cancel" onclick="closeInstantModal()"><i class="fas fa-times"></i> <span data-i18n="close">Fermer</span></button>
      </div>
    </div>
  </div>

<script>
  // ===== Defaults =====
  const defaultValues = {
    nombrePoules:10000, mortaliteCycle:6, ageDebut:20, ageFin:80,
    prixPoullette:850, prixOeuf:17, modelePic:93, semainePic:30, declinHebdo:0.35,
    consoJour:110, prixAliment:72, coefConsoPic:0.12,
    location:400000, mainOeuvre:550000, energie:200000, santeParPoule:120, autresFrais:180000,
    coutEau:60000, assurance:70000, fraisBancaires:35000, fraisVeterinaire:0
  };

  let previousResults=null;
  let costDistributionChart=null, sensitivityChart=null, layingCurveChart=null, benchmarkChart=null;

  function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
  function fmtNumber(n,dec=0){
    const locale = "fr-FR";
    return Number(n).toLocaleString(locale,{useGrouping:true, minimumFractionDigits:dec, maximumFractionDigits:dec});
  }
  function showNotification(msg,type="success"){
    const n=document.getElementById("notification");
    n.textContent=msg; n.className=`notification ${type} show`;
    setTimeout(()=>n.classList.remove("show"),2400);
  }

  function switchTab(id){
    // Active la section demandée
    document.querySelectorAll(".tab-content").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    const target = document.getElementById(id);
    if(target) target.classList.add("active");

    // Active l'onglet correspondant
    const map={"tab-parametres":0,"tab-resultats":1,"tab-benchmarks":2};
    const idx = map[id];
    const tabs = document.querySelectorAll("#mainTabs .tab");
    if(Number.isInteger(idx) && tabs[idx]) tabs[idx].classList.add("active");
  }

  function initApp(){
    document.getElementById("advancedToggle").addEventListener("change",(e)=>{
      document.getElementById("advancedOptions").style.display = e.target.checked ? "block" : "none";
    });
    document.getElementById("useObserved").addEventListener("change",(e)=>{
      document.getElementById("observedBlock").style.display = e.target.checked ? "block" : "none";
    });
    applyLanguage();
    applyCurrency();
    if(document.getElementById('scenariosList')) { try{ renderScenarios(); } catch(e){} }
    calculerCycle(true);
  }

  function readInputs(){
    const get=id=>Number(document.getElementById(id).value||0);
    const getMoney=id=>moneyValDzd(id);
    return {
      nombrePoules:get("nombrePoules"),
      mortaliteCycle:get("mortaliteCycle"),
      ageDebut:get("ageDebut"),
      ageFin:get("ageFin"),
      prixPoullette:getMoney("prixPoullette"),
      prixOeuf:getMoney("prixOeuf"),
      modelePic:get("modelePic"),
      semainePic:get("semainePic"),
      declinHebdo:get("declinHebdo"),
      consoJour:get("consoJour"),
      prixAliment:getMoney("prixAliment"),
      coefConsoPic:get("coefConsoPic"),
      location:getMoney("location"),
      mainOeuvre:getMoney("mainOeuvre"),
      energie:getMoney("energie"),
      santeParPoule:getMoney("santeParPoule"),
      autresFrais:getMoney("autresFrais"),
      coutEau:getMoney("coutEau"),
      assurance:getMoney("assurance"),
      fraisBancaires:getMoney("fraisBancaires"),
      fraisVeterinaire:getMoney("fraisVeterinaire")
    };
  }

  // ===== Model =====
  function layingRateByWeek(ageWeek,p){
    const start=p.ageDebut, peakW=p.semainePic, peak=p.modelePic, decline=p.declinHebdo;
    if(ageWeek<start) return 0;
    if(ageWeek<=peakW){
      const startPct=0.55*peak;
      const t=(ageWeek-start)/Math.max(1e-6,(peakW-start));
      return clamp(startPct + t*(peak-startPct),0,peak);
    }
    const pct=peak - (ageWeek-peakW)*decline;
    return clamp(pct,0,peak);
  }
  function feedByWeek(baseG,layPct,peakPct,coef){
    const ratio = (peakPct<=0)?0:(layPct/peakPct);
    return baseG*(1+coef*ratio);
  }

  function calculerCycle(silent=false){
    const p=readInputs();
    if(p.ageFin<=p.ageDebut){ if(!silent) showNotification("Âge fin doit être > âge début.","error"); return; }
    if(p.nombrePoules<=0){ if(!silent) showNotification("Nombre de poules invalide.","error"); return; }

    const weeks=Math.round(p.ageFin-p.ageDebut+1);
    const days=weeks*7;

    const mort=clamp(p.mortaliteCycle/100,0,0.6);
    const hensStart=p.nombrePoules;
    const hensEnd=hensStart*(1-mort);

    let eggsTotal=0, layingSum=0, feedTotalKg=0;
    const curveWeeks=[], curveVals=[];

    for(let w=p.ageDebut; w<=p.ageFin; w++){
      const lay=layingRateByWeek(w,p);
      curveWeeks.push(w); curveVals.push(lay);
      layingSum+=lay;
      const progress=(w-p.ageDebut)/Math.max(1e-6,(p.ageFin-p.ageDebut));
      const hensW=hensStart + progress*(hensEnd-hensStart);
      eggsTotal += hensW*(lay/100)*7;
      const feedG = feedByWeek(p.consoJour,lay,p.modelePic,p.coefConsoPic);
      feedTotalKg += hensW*(feedG/1000)*7;
    }

    const layingAvg=layingSum/weeks;
    const trays=eggsTotal/30;
    const CA=eggsTotal*p.prixOeuf;

    const costPullets=hensStart*p.prixPoullette;
    const costFeed=feedTotalKg*p.prixAliment;
    const costHealth=hensStart*p.santeParPoule;
    const costLabour=p.mainOeuvre;
    const costEnergy=p.energie;
    const costOther=p.location+p.autresFrais+p.coutEau+p.assurance+p.fraisBancaires+p.fraisVeterinaire;
    const costTotal=costPullets+costFeed+costHealth+costLabour+costEnergy+costOther;

    const profit=CA-costTotal;
    const marginPct=(CA>0)?profit/CA*100:0;
    const roiPct=(costTotal>0)?profit/costTotal*100:0;

    const ePHH=(hensStart>0)?eggsTotal/hensStart:0;
    const feedPerEggG=(eggsTotal>0)?(feedTotalKg*1000/eggsTotal):0;
    const costPerEgg=(eggsTotal>0)?(costTotal/eggsTotal):0;
    const profitHen=(hensStart>0)?(profit/hensStart):0;

    const eggsPerDayAvg=eggsTotal/days;
    const CAday=CA/days, costDay=costTotal/days, profitDay=profit/days;

    const breakEvenEgg=(eggsTotal>0)?(costTotal/eggsTotal):0;

    // UI
    document.getElementById("resultEggs").innerText=fmtNumber(eggsTotal,0);
    document.getElementById("resultTrays").innerText=fmtNumber(trays,0);
    document.getElementById("resultCA").innerText=fmtMoney(CA,0,"");
    document.getElementById("resultCoutTotal").innerText=fmtMoney(costTotal,0,"");
    document.getElementById("resultBenefice").innerText=fmtMoney(profit,0,"");
    document.getElementById("resultMargePourcentage").innerText=fmtNumber(marginPct,1)+"%";
    document.getElementById("resultSeuil").innerText=fmtMoney(breakEvenEgg,4,"/œuf");
    document.getElementById("resultROI").innerText=fmtNumber(roiPct,1)+"%";

    document.getElementById("resultEPHH").innerText=fmtNumber(ePHH,1);
    document.getElementById("resultLayingAvg").innerText=fmtNumber(layingAvg,1)+"%";
    document.getElementById("resultFeedKg").innerText=fmtNumber(feedTotalKg,0)+" kg";
    document.getElementById("resultFeedPerEgg").innerText=fmtNumber(feedPerEggG,1)+" g/œuf";
    document.getElementById("resultCostPerEgg").innerText=fmtMoney(costPerEgg,4,"/œuf");
    document.getElementById("resultProfitHen").innerText=fmtMoney(profitHen,0,"");

    document.getElementById("resultDays").innerText=fmtNumber(days,0)+" j";
    document.getElementById("resultEggsPerDay").innerText=fmtNumber(eggsPerDayAvg,0);
    document.getElementById("resultCAperDay").innerText=fmtMoney(CAday,0,"");
    document.getElementById("resultCostPerDay").innerText=fmtMoney(costDay,0,"");
    document.getElementById("resultProfitPerDay").innerText=fmtMoney(profitDay,0,"");

    const pct=x=>(costTotal>0)?(x/costTotal*100):0;
    document.getElementById("resultCostPullets").innerText=fmtMoney(costPullets,0,"");
    document.getElementById("resultCostPulletsPct").innerText=fmtNumber(pct(costPullets),1)+"%";
    document.getElementById("resultCostFeed").innerText=fmtMoney(costFeed,0,"");
    document.getElementById("resultCostFeedPct").innerText=fmtNumber(pct(costFeed),1)+"%";
    document.getElementById("resultCostHealth").innerText=fmtMoney(costHealth,0,"");
    document.getElementById("resultCostHealthPct").innerText=fmtNumber(pct(costHealth),1)+"%";
    document.getElementById("resultCostLabour").innerText=fmtMoney(costLabour,0,"");
    document.getElementById("resultCostLabourPct").innerText=fmtNumber(pct(costLabour),1)+"%";
    document.getElementById("resultCostEnergy").innerText=fmtMoney(costEnergy,0,"");
    document.getElementById("resultCostEnergyPct").innerText=fmtNumber(pct(costEnergy),1)+"%";
    document.getElementById("resultCostOther").innerText=fmtMoney(costOther,0,"");
    document.getElementById("resultCostOtherPct").innerText=fmtNumber(pct(costOther),1)+"%";

    // sensitivity helper
    function sens(priceEggFactor=1, feedFactor=1, mortAdd=0){
      const p2={...p, prixOeuf:p.prixOeuf*priceEggFactor, prixAliment:p.prixAliment*feedFactor, mortaliteCycle:clamp(p.mortaliteCycle+mortAdd,0,30)};
      const mort2=clamp(p2.mortaliteCycle/100,0,0.6);
      const hensEnd2=hensStart*(1-mort2);
      let eggs=0, feedKg=0;
      for(let w=p2.ageDebut; w<=p2.ageFin; w++){
        const lay=layingRateByWeek(w,p2);
        const progress=(w-p2.ageDebut)/Math.max(1e-6,(p2.ageFin-p2.ageDebut));
        const hensW=hensStart + progress*(hensEnd2-hensStart);
        eggs += hensW*(lay/100)*7;
        const feedG=feedByWeek(p2.consoJour,lay,p2.modelePic,p2.coefConsoPic);
        feedKg += hensW*(feedG/1000)*7;
      }
      const CA2=eggs*p2.prixOeuf;
      const costFeed2=feedKg*p2.prixAliment;
      const costTotal2=costPullets+costFeed2+costHealth+costLabour+costEnergy+costOther;
      const profit2=CA2-costTotal2;
      const margin2=(CA2>0)?profit2/CA2*100:0;
      return {profit:profit2, margin:margin2};
    }

    const sEggPlus=sens(1.10,1,0), sEggMinus=sens(0.90,1,0), sFeedPlus=sens(1,1.10,0), sMortPlus=sens(1,1,2);
    document.getElementById("resultSensEggPlus").innerText=fmtMoney(sEggPlus.profit,0,"");
    document.getElementById("resultSensEggPlusPct").innerText=fmtNumber(sEggPlus.margin,1)+"%";
    document.getElementById("resultSensEggMinus").innerText=fmtMoney(sEggMinus.profit,0,"");
    document.getElementById("resultSensEggMinusPct").innerText=fmtNumber(sEggMinus.margin,1)+"%";
    document.getElementById("resultSensFeedPlus").innerText=fmtMoney(sFeedPlus.profit,0,"");
    document.getElementById("resultSensFeedPlusPct").innerText=fmtNumber(sFeedPlus.margin,1)+"%";
    document.getElementById("resultSensMortPlus").innerText=fmtMoney(sMortPlus.profit,0,"");
    document.getElementById("resultSensMortPlusPct").innerText=fmtNumber(sMortPlus.margin,1)+"%";

    // dashboard
    document.getElementById("dashboard-eggs").innerText=fmtNumber(eggsTotal,0);
    document.getElementById("dashboard-ca").innerHTML = renderDashMoney(CA,0);
    document.getElementById("dashboard-profit").innerHTML = renderDashMoney(profit,0);
    document.getElementById("dashboard-feed").innerHTML=fmtNumber(feedTotalKg,0)+' <span class="dashboard-unit">kg</span>';

    // benchmarks
    document.getElementById("bmEggsHen").innerText=fmtNumber(ePHH,1);
    document.getElementById("bmPeak").innerText=fmtNumber(p.modelePic,1)+"%";
    document.getElementById("bmFeed").innerText=fmtNumber(p.consoJour,0);
    document.getElementById("bmFeedEgg").innerText=fmtNumber(feedPerEggG,1);
    document.getElementById("bmProfitHen").innerText=fmtNumber(profitHen,0);

    function statusBand(elId,val,goodMin,goodMax,warnMin,warnMax,lowerBetter=false){
      const el=document.getElementById(elId);
      let cls="good", label="-";
      if(lowerBetter){
        if(val<=goodMax){cls="good";label="Bon";}
        else if(val<=warnMax){cls="warning";label="Moyen";}
        else{cls="bad";label="Faible";}
      }else{
        if(val>=goodMin && val<=goodMax){cls="good";label="Bon";}
        else if(val>=warnMin && val<=warnMax){cls="warning";label="Moyen";}
        else{cls="bad";label="Faible";}
      }
      el.className=cls; el.innerText=label;
    }
    statusBand("bmEggsHenStatus", ePHH, 280,310, 300,330, false);
    statusBand("bmPeakStatus", p.modelePic, 90,94, 92,96, false);
    statusBand("bmFeedStatus", p.consoJour, 0,115, 0,112, true);    // lower better
    statusBand("bmFeedEggStatus", feedPerEggG, 0,145, 0,140, true);
    statusBand("bmProfitHenStatus", profitHen, 400,900, 600,1200, false);

    updateRecommendations({ePHH, layingAvg, feedPerEggG, profitHen, costPerEgg, breakEvenEgg, p});

    previousResults={
      profit, costs:{costPullets,costFeed,costHealth,costLabour,costEnergy,costOther},
      sens:{base:profit, plusEgg:sEggPlus.profit, minusEgg:sEggMinus.profit, plusFeed:sFeedPlus.profit, plusMort:sMortPlus.profit},
      curveWeeks, curveVals,
      radar:[ePHH,p.modelePic,p.consoJour,feedPerEggG,profitHen]
    };
    // Met à jour les graphes uniquement si l'onglet Analyses est visible (sinon Chart.js calcule des tailles 0)
    if(document.getElementById('tab-analyses')?.classList.contains('active')){
      updateAllCharts();
    }
    if(!silent) showNotification("Calcul du cycle terminé.","success");
  }

  function updateRecommendations(r){
    const box=document.getElementById("recommendationsList");
    const items=[];
    if(r.profitHen<0) items.push("⚠️ Marge négative : vérifier prix œuf, coût aliment et charges fixes.");
    if(r.feedPerEggG>145) items.push("🍽️ Consommation/œuf élevée : ajuster ration, énergie/protéines, santé intestinale, pertes.");
    if(r.layingAvg<80) items.push("🥚 Ponte moyenne faible : vérifier lumière, conduite, uniformité, qualité aliment, statut sanitaire.");
    if(r.ePHH<270) items.push("📉 Œufs/poule logée bas : contrôler mortalité, démarrage, qualité poulettes et gestion du pic.");
    if(r.p.mortaliteCycle>8) items.push("🏥 Mortalités élevées : renforcer biosécurité, vaccination, confort et ventilation.");
    items.push("✅ Conseil : utilisez le bouton « Calcul instantané » pour analyser un jour/une semaine précise du cycle.");
    box.innerHTML="<ul style='padding-left:20px;'>"+items.map(x=>`<li style="margin-bottom:8px;">${x}</li>`).join("")+"</ul>";
  }

  // ===== Instant =====
  function openInstantModal(){ document.getElementById("instantModal").style.display="flex"; }
  function closeInstantModal(){ document.getElementById("instantModal").style.display="none"; }

  function calculerInstant(){
    const p=readInputs();
    const t=Number(document.getElementById("instantWeek").value||0);
    const j=Number(document.getElementById("instantDay").value||0);
    const ageWeek = (t>0) ? (p.ageDebut + t) : (p.ageDebut + Math.floor(j/7));
    const layModel = layingRateByWeek(ageWeek,p);

    const useObs=document.getElementById("useObserved").checked;
    const layPct = useObs ? clamp(Number(document.getElementById("observedLaying").value||layModel),0,100) : layModel;
    const feedG = useObs ? clamp(Number(document.getElementById("observedFeed").value||p.consoJour),50,250) : feedByWeek(p.consoJour,layPct,p.modelePic,p.coefConsoPic);

    const mort=clamp(p.mortaliteCycle/100,0,0.6);
    const hensStart=p.nombrePoules;
    const hensEnd=hensStart*(1-mort);
    const progress=clamp((ageWeek-p.ageDebut)/Math.max(1e-6,(p.ageFin-p.ageDebut)),0,1);
    const hensW=hensStart + progress*(hensEnd-hensStart);

    const eggsDay=hensW*(layPct/100);
    const feedDayKg=hensW*(feedG/1000);
    const CAday=eggsDay*p.prixOeuf;
    const feedCostDay=feedDayKg*p.prixAliment;
    const marginDay=CAday-feedCostDay;

    document.getElementById("instLayingPct").innerText=fmtNumber(layPct,1)+"%";
    document.getElementById("instEggsDay").innerText=fmtNumber(eggsDay,0);
    document.getElementById("instFeedDay").innerText=fmtNumber(feedDayKg,1)+" kg";
    document.getElementById("instCAday").innerText=fmtMoney(CAday,0,"");
    document.getElementById("instFeedCostDay").innerText=fmtMoney(feedCostDay,0,"");
    document.getElementById("instMarginDay").innerText=fmtMoney(marginDay,0,"");
  }

  // ===== Charts =====
  function updateAllCharts(){
    if(!previousResults) return;
    const ctx1=document.getElementById("costDistributionChart");
    const ctx2=document.getElementById("sensitivityChart");
    const ctx3=document.getElementById("layingCurveChart");
    const ctx4=document.getElementById("benchmarkChart");

    const c=previousResults.costs;
    const labelsCost=["Poulettes","Aliment","Santé","Main d'œuvre","Énergie","Autres"];
    const dataCost=[c.costPullets,c.costFeed,c.costHealth,c.costLabour,c.costEnergy,c.costOther];

    if(costDistributionChart) costDistributionChart.destroy();
    costDistributionChart=new Chart(ctx1,{type:"doughnut",data:{labels:labelsCost,datasets:[{data:dataCost}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom",labels:{boxWidth:12}}},layout:{padding:6}}});

    const labelsSens=["Base","+10% prix œuf","-10% prix œuf","+10% coût aliment","+2% mortalité"];
    const dataSens=[previousResults.sens.base,previousResults.sens.plusEgg,previousResults.sens.minusEgg,previousResults.sens.plusFeed,previousResults.sens.plusMort];
    if(sensitivityChart) sensitivityChart.destroy();
    sensitivityChart=new Chart(ctx2,{type:"bar",data:{labels:labelsSens,datasets:[{data:dataSens}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom",labels:{boxWidth:12}}},layout:{padding:6}}});

    if(layingCurveChart) layingCurveChart.destroy();
    layingCurveChart=new Chart(ctx3,{type:"line",data:{labels:previousResults.curveWeeks,datasets:[{data:previousResults.curveVals}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom",labels:{boxWidth:12}}},layout:{padding:6},scales:{y:{beginAtZero:true,max:100}}}});

    if(benchmarkChart) benchmarkChart.destroy();
    benchmarkChart=new Chart(ctx4,{type:"radar",data:{labels:["Œufs/poule","Pic (%)","Conso (g/j)","g/œuf","Profit/poule"],datasets:[{data:previousResults.radar}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom",labels:{boxWidth:12}}},layout:{padding:6}}});
  }

  // ===== Scenarios =====
  function renderScenarios(){
    const box=document.getElementById("scenariosList");
    if(!box) return;
    const list=JSON.parse(localStorage.getItem("layers_scenarios")||"[]");
    if(!list.length){
      box.innerHTML='<p style="color:var(--text-light);font-style:italic;text-align:center;padding:18px;">Aucun scénario sauvegardé pour le moment</p>';
      return;
    }
    box.innerHTML=list.map((s,i)=>`
      <div style="background:#f8f9fa;border-radius:8px;padding:12px;margin-bottom:10px;display:flex;justify-content:space-between;gap:10px;align-items:center;">
        <div><strong>${s.name}</strong><div style="font-size:12px;color:#666;">${new Date(s.ts).toLocaleString()}</div></div>
        <div style="display:flex;gap:8px;">
          <button class="modal-btn confirm" style="padding:8px 12px;" onclick="loadScenario(${i})"><i class="fas fa-upload"></i> Charger</button>
          <button class="modal-btn cancel" style="padding:8px 12px;" onclick="deleteScenario(${i})"><i class="fas fa-trash"></i> Suppr.</button>
        </div>
      </div>
    `).join("");
  }
  function saveScenario(){
    const p=readInputs();
    const list=JSON.parse(localStorage.getItem("layers_scenarios")||"[]");
    const name=prompt("Nom du scénario :");
    if(!name) return;
    list.push({name,params:p,ts:Date.now()});
    localStorage.setItem("layers_scenarios",JSON.stringify(list));
    if(document.getElementById('scenariosList')) { try{ renderScenarios(); } catch(e){} }
    showNotification("Scénario sauvegardé.","success");
  }
  function loadScenario(i){
    const list=JSON.parse(localStorage.getItem("layers_scenarios")||"[]");
    const s=list[i]; if(!s) return;
    Object.keys(s.params).forEach(k=>{const el=document.getElementById(k); if(el) el.value=s.params[k];});
    calculerCycle(true);
    showNotification("Scénario chargé.","success");
  }
  function deleteScenario(i){
    const list=JSON.parse(localStorage.getItem("layers_scenarios")||"[]");
    list.splice(i,1);
    localStorage.setItem("layers_scenarios",JSON.stringify(list));
    if(document.getElementById('scenariosList')) { try{ renderScenarios(); } catch(e){} }
    showNotification("Scénario supprimé.","success");
  }

  // ===== Comparison (simple) =====
  function showComparisonModal(){ renderComparisonList(); document.getElementById("comparisonModal").style.display="flex"; }
  function closeComparisonModal(){ document.getElementById("comparisonModal").style.display="none"; }
  function renderComparisonList(){
    const list=JSON.parse(localStorage.getItem("layers_scenarios")||"[]");
    const box=document.getElementById("comparisonScenariosList");
    if(!list.length){ box.innerHTML="<p style='color:#666;'>Aucun scénario.</p>"; return; }
    box.innerHTML=list.map((s,i)=>`
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #eee;">
        <input type="checkbox" class="cmpCheck" value="${i}">
        <div><strong>${s.name}</strong><div style="font-size:12px;color:#666;">${new Date(s.ts).toLocaleString()}</div></div>
      </div>
    `).join("");
  }
  function compareScenarios(){
    const ids=[...document.querySelectorAll(".cmpCheck")].filter(x=>x.checked).map(x=>Number(x.value));
    if(ids.length<2){ showNotification("Sélectionnez au moins 2 scénarios.","warning"); return; }
    showNotification("v1 : chargez un scénario puis un autre pour comparer (tableau).","warning");
  }

  // ===== PDF =====
  function showPDFModal(){ document.getElementById("pdfModal").style.display="flex"; }
  function closePDFModal(){ document.getElementById("pdfModal").style.display="none"; }
  async function generatePDF(){
    try{
      calculerCycle(true);
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF("p","mm","a4");
      const p=readInputs();
      doc.setFontSize(16);
      doc.text((INOIA_LANG==="ar")?"تقرير – حساب البياض":"Rapport – Calculateur pondeuse",14,16);
      doc.setFontSize(11);
      doc.text(`INOIATECH – ${new Date().toLocaleString()}`,14,24);

      let y=32;
      if(document.getElementById("includeParameters").checked){
        doc.setFontSize(12); doc.text((INOIA_LANG==="ar")?"المعلمات":"Paramètres",14,y); y+=4;
        doc.autoTable({
          startY:y,
          head:[["Paramètre","Valeur"]],
          body:[
            ["Nombre de poules", String(p.nombrePoules)],
            ["Âge début/fin", `${p.ageDebut} - ${p.ageFin} sem`],
            ["Mortalité cycle", `${p.mortaliteCycle}%`],
            ["Prix œuf", `${p.prixOeuf} DA`],
            ["Prix aliment", `${p.prixAliment} DA/kg`],
            ["Conso (moy)", `${p.consoJour} g/j`],
            ["Pic (%) / semaine", `${p.modelePic}% / ${p.semainePic}`],
            ["Déclin", `${p.declinHebdo}%/sem`]
          ],
          theme:"grid"
        });
        y = doc.lastAutoTable.finalY + 8;
      }
      if(document.getElementById("includeResults").checked){
        doc.setFontSize(12); doc.text((INOIA_LANG==="ar")?"النتائج":"Résultats",14,y); y+=4;
        doc.autoTable({
          startY:y,
          head:[["Indicateur","Valeur"]],
          body:[
            ["Œufs totaux", document.getElementById("resultEggs").innerText],
            ["CA total", document.getElementById("resultCA").innerText],
            ["Coût total", document.getElementById("resultCoutTotal").innerText],
            ["Bénéfice net", document.getElementById("resultBenefice").innerText],
            ["EPHH", document.getElementById("resultEPHH").innerText],
            ["Coût/œuf", document.getElementById("resultCostPerEgg").innerText]
          ],
          theme:"grid"
        });
      }
      doc.save("INOIATECH_Pondeuse_Rapport.pdf");
      closePDFModal();
      showNotification("PDF généré.","success");
    }catch(e){
      console.error(e);
      showNotification("Erreur PDF (librairie).","error");
    }
  }

  function resetToDefaults(){
    Object.keys(defaultValues).forEach(k=>{const el=document.getElementById(k); if(el) el.value=defaultValues[k];});
    calculerCycle(true);
    showNotification("Valeurs réinitialisées.","success");
  }
</script>


</body>
</html>